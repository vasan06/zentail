<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZenTail Admin - Dashboard</title>
  <link rel="stylesheet" href="/static/css/styles2.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root { 
        --accent: #bb6a7f; 
        --bg: #f4f7f6; 
        --glass: rgba(255, 255, 255, 0.95); 
        --emergency: #ff4d4f; 
        --success: #52c41a;
    }
    
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: #333; margin: 0; padding: 15px; }
    .container { max-width: 1100px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 10px; }

    /* SECTION STYLING */
    .section-title { margin: 35px 0 15px; color: var(--accent); display: flex; align-items: center; gap: 10px; font-size: 22px; }
    .info-pill { background: #eee; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; color: #555; border: 1px solid #ddd; display: inline-block; }
    .clinic-tag { background: #f0f4ff; color: #0052cc; border-color: #d0e0ff; }

    /* FILTER BAR */
    .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding: 5px 0; }
    .filter-btn { 
        padding: 8px 18px; border-radius: 20px; border: 1px solid #ddd; 
        background: white; cursor: pointer; font-size: 13px; font-weight: 600; 
        transition: 0.3s; white-space: nowrap;
    }
    .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

    /* APPOINTMENT PANEL - RESPONSIVE GRID */
    .appointment-panel { 
        background: var(--glass); border-radius: 25px; padding: 20px; margin-bottom: 15px;
        display: grid; grid-template-columns: 1fr; gap: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05);
        transition: transform 0.3s ease;
    }

    /* Desktop view: 3 columns */
    @media (min-width: 768px) {
        .appointment-panel { grid-template-columns: 1.2fr 2fr 1fr; gap: 25px; padding: 25px; }
    }

    .appointment-panel:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(187,106,127,0.1); }

    /* EMERGENCY LOGIC */
    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(255, 77, 79, 0.4); }
        70% { box-shadow: 0 0 0 12px rgba(255, 77, 79, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 77, 79, 0); }
    }
    .emergency-card { border-left: 10px solid var(--emergency) !important; animation: pulse-red 2s infinite; background: #fff1f0; }

    /* DATA ELEMENTS */
    .pet-info h3 { margin: 5px 0; color: #222; font-size: 18px; }
    .pet-info p { margin: 4px 0; color: #666; font-size: 14px; }
    .reason-box { background: #fdf2f4; padding: 15px; border-radius: 15px; font-size: 13px; color: #8a4a59; border-left: 4px solid var(--accent); }
    
    /* BUTTONS */
    .btn-group { display: flex; flex-direction: column; gap: 8px; }
    .btn { border: none; padding: 11px; border-radius: 12px; cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-approve { background: #e6f7ed; color: #237804; }
    .btn-cancel { background: #fff1f0; color: #a8071a; }
    .btn-contact { background: #f9f0ff; color: #722ed1; }
    .btn-del { background: #eee; color: #666; font-size: 11px; margin-top: 5px; }
    .btn:hover { filter: brightness(0.95); transform: scale(1.02); }

    /* POPUP */
    #customPopup { 
        display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
        background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 10000;
        align-items: center; justify-content: center; padding: 20px;
    }
    .popup-card { 
        background: white; width: 100%; max-width: 400px; border-radius: 30px; padding: 30px; 
        text-align: center; box-shadow: 0 25px 60px rgba(0,0,0,0.2); box-sizing: border-box;
    }
    .history-card {
    opacity: 0.85;
}
.history-cancelled {
    border-left: 10px solid #888 !important;
}
.history-completed {
    border-left: 10px solid #0958d9 !important;
}
    .cancel-option { width: 100%; padding: 12px; margin-top: 8px; border-radius: 12px; border: 1px solid #eee; background: #fafafa; cursor: pointer; font-weight: 600; text-align: left; font-size: 14px; }
    .cancel-option:hover { background: var(--accent); color: white; }
    textarea { width: 100%; border-radius: 12px; border: 1px solid #ddd; padding: 12px; margin-top: 10px; font-family: inherit; resize: vertical; box-sizing: border-box; }
  </style>
</head>
<body>

<div class="container">
    <button class="back-btn" type="button" onclick="window.history.back()">
    <span class="back-icon">‚Üê</span>
    <span class="back-label">Back</span>
  </button><br><br><br>
    <div class="header">
        <h1 style="margin:0;">ZenTail Admin</h1>
        <!-- <button class="btn" style="background:#eee" onclick="window.history.back()">Back</button> -->
    </div>

    <h2 class="section-title"><i class="fa-solid fa-stethoscope"></i> New & Urgent Requests</h2>
    {% for appt in appointments if appt.status == 'pending' %}
        {% set r = appt.reason|lower if appt.reason else '' %}
        {% set is_em = 'accident' in r or 'injury' in r or 'emergency' in r or 'vomiting' in r or 'bleeding' in r or 'fracture' in r or 'surgery' in r %}
        
        <div class="appointment-panel {{ 'emergency-card' if is_em }}">
            <div class="pet-info">
                <div class="info-pill clinic-tag"><i class="fa-solid fa-hospital"></i> {{ appt.clinic_name or 'General Clinic' }}</div>
                <h3>{{ appt.pet_name }} <span style="font-weight:400; font-size:14px;">({{ appt.pet_type }})</span></h3>
                <p><i class="fa-solid fa-calendar"></i> {{ appt.date or 'Pending' }} | <i class="fa-solid fa-clock"></i> {{ appt.time or 'Pending' }}</p>
                <p><i class="fa-solid fa-user"></i> {{ appt.owner_name }}</p>
            </div>
            <div class="reason-box">
                <strong>Complaint / Reason:</strong><br>
                {{ appt.reason }}
            </div>
            <div class="btn-group">
                <button class="btn btn-approve" onclick="triggerAction('approve', '{{ appt._id }}', 'Confirmed! üêæ')">
                    <i class="fa-solid fa-check"></i> Approve
                </button>
                <button class="btn btn-cancel" onclick="openCancelModal('{{ appt._id }}')">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button class="btn btn-contact" onclick="openContact('{{ appt.owner_name }}', '{{ appt.contact }}', '{{ appt.email }}')">
                    Contact
                </button>
            </div>
        </div>
    {% endfor %}

    <h2 class="section-title"><i class="fa-solid fa-circle-check"></i> Approved Appointments</h2>
    {% for appt in appointments if appt.status == 'confirmed' and not appt.consulted %}
        <div class="appointment-panel" style="border-left: 8px solid var(--success);">
            <div class="pet-info">
                <h3>{{ appt.pet_name }}</h3>
                <p><i class="fa-solid fa-clock"></i> {{ appt.date }} at {{ appt.time }}</p>
                <p>Owner: {{ appt.owner_name }}</p>
            </div>
            <div class="reason-box" style="background: #f6ffed; color: #389e0d; border-left-color: var(--success);">
                <strong>Status:</strong> Waiting for Consultation
            </div>
            <div class="btn-group">
                <button class="btn" style="background:#e6f4ff; color:#0958d9" onclick="triggerAction('consulted', '{{ appt._id }}', 'Marked Done! ‚ú®')">
                    <i class="fa-solid fa-heart"></i> Mark Done
                </button>
                <button class="btn btn-del" onclick="triggerAction('delete', '{{ appt._id }}', 'Deleted')">
                    üóë Delete Record
                </button>
            </div>
        </div>
    {% endfor %}

    <h2 class="section-title" style="color:#888;"><i class="fa-solid fa-clock-rotate-left"></i> Treatment History</h2>
    
    <div class="filter-bar">
        <button class="filter-btn active" onclick="filterHistory('all', this)">All History</button>
        <button class="filter-btn" onclick="filterHistory('completed', this)">Completed</button>
        <button class="filter-btn" onclick="filterHistory('cancelled', this)">Cancelled</button>
    </div>

<div id="history-container">
    {% for appt in appointments if appt.status == 'Cancelled' or appt.consulted %}
       <div class="appointment-panel history-card {{ 'history-cancelled' if appt.status == 'Cancelled' else 'history-completed' }}" 
     data-status="{{ 'completed' if appt.consulted else 'cancelled' }}">
            <div class="pet-info">
                <h3>{{ appt.pet_name }}</h3>
                <p>Status: <strong>{{ '‚úÖ Consulted' if appt.consulted else '‚ùå Cancelled' }}</strong></p>
                <p><small>{{ appt.date }} | {{ appt.time }}</small></p>
            </div>
            <div class="reason-box">
                {% if appt.status == 'Cancelled' %}
                    <strong>Reason:</strong> {{ appt.cancel_reason or 'No reason provided' }}
                {% else %}
                    <strong>Outcome:</strong> Treatment provided successfully.
                {% endif %}
            </div>
            <div class="btn-group">
                <button class="btn btn-contact" onclick="openContact('{{ appt.owner_name }}', '{{ appt.contact }}', '{{ appt.email }}')">
                    <i class="fa-solid fa-circle-info"></i> Info
                </button>
                <button class="btn" style="background:#e6f4ff; color:#0958d9" onclick="triggerAction('reopen', '{{ appt._id }}', 'Re-instated')">
                    <i class="fa-solid fa-rotate-left"></i> Re-Open
                </button>
                <button class="btn btn-del" onclick="triggerAction('delete', '{{ appt._id }}', 'History Cleared')">
                    <i class="fa-solid fa-trash-can"></i> Delete Permanently
                </button>
            </div>
        </div>
    {% endfor %}
</div>
</div>

<div id="customPopup">
    <div class="popup-card" id="popupContent"></div>
</div>

<script>
    const popup = document.getElementById('customPopup');
    const content = document.getElementById('popupContent');

    // 1. ACTION HANDLER (Approve, Consulted, Delete, Reopen)
    function triggerAction(action, id, successMsg) {
        if(action === 'delete' && !confirm("Are you sure you want to delete this permanent record?")) return;

        fetch(`/admin/appointments/${action}/${id}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                showFinalPopup("üêæ", successMsg, "Dashboard updated.");
                setTimeout(() => location.reload(), 1200);
            }
        });
    }

    // 2. HISTORY FILTERING
    function filterHistory(status, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.querySelectorAll('.history-card').forEach(card => {
            if(status === 'all' || card.dataset.status === status) {
                card.style.display = 'grid';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // 3. ENHANCED CANCEL MODAL (5 Reasons + Custom)
    function openCancelModal(id) {
        content.innerHTML = `
            <div class="popup-icon" style="font-size:40px;">üö´</div>
            <h2 style="margin-top:10px;">Cancel Appointment?</h2>
            <p style="color:#666; font-size:13px;">Select a reason to notify the client via email.</p>
            
            <div style="margin: 15px 0;">
                <button class="cancel-option" onclick="submitCancel('${id}', 'Doctor is currently unavailable')">üë®‚Äç‚öïÔ∏è Doctor Unavailable</button>
                <button class="cancel-option" onclick="submitCancel('${id}', 'Clinic is fully booked for this slot')">üè• Clinic Fully Booked</button>
                <button class="cancel-option" onclick="submitCancel('${id}', 'Emergency surgery in progress')">üö® Emergency Surgery</button>
                <button class="cancel-option" onclick="submitCancel('${id}', 'Clinic closed due to holiday/maintenance')">üöß Clinic Closed</button>
                <button class="cancel-option" onclick="showOtherInput()">üìù Other Reason...</button>
            </div>

            <div id="other-container" style="display:none;">
                <textarea id="custom-reason-text" placeholder="Type specific reason for the client..."></textarea>
                <button class="btn btn-approve" style="width:100%; margin-top:10px;" onclick="submitCustomCancel('${id}')">Send Custom Cancellation</button>
            </div>

            <button class="btn" style="width:100%; margin-top:10px; background:#f4f4f4;" onclick="popup.style.display='none'">Back</button>
        `;
        popup.style.display = 'flex';
    }

    function showOtherInput() {
        document.getElementById('other-container').style.display = 'block';
    }

    function submitCustomCancel(id) {
        const customReason = document.getElementById('custom-reason-text').value;
        if(!customReason) return alert("Please type a reason.");
        submitCancel(id, customReason);
    }

    function submitCancel(id, reason) {
        fetch(`/admin/appointments/cancel/${id}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ reason: reason })
        }).then(() => {
            showFinalPopup("üìß", "Cancelled!", "Client has been notified via email.");
            setTimeout(() => location.reload(), 1500);
        });
    }

    // 4. CONTACT POPUP
    function openContact(name, phone, email) {
        content.innerHTML = `
            <div class="popup-icon" style="font-size:40px;">üë§</div>
            <h3>Owner Information</h3>
            <div style="text-align:left; background:#f9f9f9; padding:15px; border-radius:15px; margin-bottom:15px; font-size:14px;">
                <p><strong>Name:</strong> ${name}</p>
                <p><strong>Phone:</strong> ${phone || 'Not Provided'}</p>
                <p><strong>Email:</strong> ${email || 'Not Provided'}</p>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" style="background:#eee;" onclick="popup.style.display='none'">Close</button>
                <a href="tel:${phone}" style="text-decoration:none;">
                    <button class="btn btn-approve" style="width:100%"><i class="fa-solid fa-phone"></i> Call</button>
                </a>
            </div>
        `;
        popup.style.display = 'flex';
    }

    function showFinalPopup(icon, title, desc) {
        content.innerHTML = `
            <div class="popup-icon" style="font-size:50px;">${icon}</div>
            <h2>${title}</h2>
            <p>${desc}</p>
        `;
        popup.style.display = 'flex';
    }
    function triggerAction(action, id, successMsg) {
    // Add a confirmation for delete actions
    if (action === 'delete') {
        if (!confirm("‚ö†Ô∏è This will permanently remove this record from the history. Proceed?")) {
            return; 
        }
    }

    fetch(`/admin/appointments/${action}/${id}`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            showFinalPopup("üóëÔ∏è", successMsg, "Record has been removed from the database.");
            setTimeout(() => location.reload(), 1200);
        } else {
            alert("Error: " + (data.error || "Could not update database."));
        }
    })
    .catch(err => console.error("Fetch Error:", err));
}
</script>
<script>
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("night-mode");
  }
</script>

</body>
</html>