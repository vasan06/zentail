<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Add/Manage Products</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
 <link rel="stylesheet" href="/static/css/styles2.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Nunito:wght@500;700&family=Micro+5&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

<main>
   <button class="back-btn" type="button" onclick="window.history.back()">
    <span class="back-icon">←</span>
    <span class="back-label">Back</span>
  </button> 
    <div class="admin-container">
             
        <h1 class="admin-title">Add New Product</h1>
       <form id="add-product-form" class="admin-form">
    
    <div class="form-group">
        <label for="name">Product Name</label>
        <input type="text" id="name" name="name" required>
    </div>
    
    <div class="form-group">
        <label for="price">Price (₹)</label>
        <input type="number" id="price" name="price" step="0.01" required>
    </div>

    <div class="form-group">
        <label for="category">Animal Category</label>
        <select id="category" name="category" required>
            <option value="Dog">Dog</option>
            <option value="Cat">Cat</option>
            <option value="Bird">Bird</option>
            <option value="Fish">Fish</option>
            <option value="Small Animal">Small Animal</option>
        </select>
    </div>
    <div class="form-group">
        <label for="type">Product Type</label>
        <select id="type" name="type" required>
            <option value="Food">Food</option>
            <option value="Lotion">Lotion</option>
            <option value="Syrup">Syrup</option>
            <option value="Medicine">Medicine</option>
            <option value="Toy">Toy</option>
            <option value="Accessory">Accessory</option>
            <option value="Other">Other</option>
        </select>
    </div>

    <div class="form-group">
        <label for="quantity">Quantity Value</label>
        <input type="number" id="quantity" name="quantity" step="0.01" value="1" required>
    </div>
    <div class="form-group">
        <label for="unit">Quantity Unit (e.g., kg, L, pcs)</label>
        <input type="text" id="unit" name="unit" value="kg" required>
    </div>

    <div class="form-group">
        <label for="brand">Brand</label>
        <input type="text" id="brand" name="brand">
    </div>

    <h2 class="admin-subtitle" style="margin-top: 30px; margin-bottom: 10px; font-size: 1.2em;">External Purchase Links</h2>

    <div class="form-group">
        <label for="url-amazon">Amazon URL (Optional)</label>
        <input type="url" id="url-amazon" name="url-amazon" placeholder="e.g., https://www.amazon.in/product-link">
    </div>
    <div class="form-group">
        <label for="url-flipkart">Flipkart URL (Optional)</label>
        <input type="url" id="url-flipkart" name="url-flipkart" placeholder="e.g., https://www.flipkart.com/product-link">
    </div>

    <div class="form-group">
        <label for="image-file">Product Image (Upload File)</label>
        <input type="file" id="image-file" name="image-file" accept="image/*" required>
        <div class="image-preview-container" id="image-preview-container" style="margin-top: 10px; display: none;">
            <p style="font-size: 0.8em; color: #888;">Preview:</p>
            <img id="image-preview" src="#" alt="Image Preview" height="50px " width="50px" class="preview-img">
        </div>
    </div>
    
    <button type="submit" class="submit-btn"><i class="fa-solid fa-plus"></i> Add Product</button>
    <p id="form-message" class="form-message"></p>

</form>

        <h1 class="admin-title" style="margin-top: 50px; margin-bottom: 0px;">Existing Products </h1>
        
       <div class="table-scroll-wrapper">

        <div class="empty-state" id="loading-state">
            <i class="fa-solid fa-spinner fa-spin"></i> Loading products...
        </div>
        <div class="product-list-header">
    <span>ID</span>
    <span>Product</span>
    <span>Category</span>
    <span>Type</span>
    <span>Price</span>
    <span>Action</span>
</div>

<div id="product-list-body" class="product-list"></div>
        <div class="empty-state" id="empty-state" style="display: none;">
            No products found. Add one above!
        </div>
    </div>
</main>
    
   <script>
    const MAX_FILE_SIZE_BYTES = 12 * 1024 * 1024;  // 12 MB limit

    document.addEventListener('DOMContentLoaded', () => {
        fetchProductsForManagement();
        
        document.getElementById('add-product-form').addEventListener('submit', submitProductForm);
        
        // Setup image preview listener
        document.getElementById('image-file').addEventListener('change', previewImage);
    });

    // --- Image Preview Logic ---

    function previewImage(event) {
        const previewContainer = document.getElementById('image-preview-container');
        const previewImg = document.getElementById('image-preview');
        const file = event.target.files[0];

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            previewContainer.style.display = 'none';
            previewImg.src = '#';
        }
    }


    // --- Product Addition Logic ---

    async function getBase64Image(file) {
        return new Promise((resolve, reject) => {
            if (!file) {
                resolve(null);
                return;
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

   async function submitProductForm(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const formMessage = document.getElementById('form-message');
    
    // Get the file object
    const imageFile = document.getElementById('image-file').files[0];

    // --- NEW SIZE CHECK LOGIC ---
    if (imageFile && imageFile.size > MAX_FILE_SIZE_BYTES) {
        formMessage.textContent = 'Error: Image size exceeds 12MB limit for storage. Please upload a smaller file.';
        formMessage.style.color = 'red';
        return; // Stop submission
    }
    // --- END NEW SIZE CHECK LOGIC ---


    formMessage.textContent = 'Processing and submitting product...';
    formMessage.style.color = '#007bff';

    try {
        // Convert file to Base64 string for storage in MongoDB
        const base64Image = await getBase64Image(imageFile);
        
        // <<< NEW LOGIC: Construct the Marketplaces Array >>>
        const marketplaces = [];
        const amazonUrl = formData.get('url-amazon');
        const flipkartUrl = formData.get('url-flipkart');
        
        if (amazonUrl) {
            marketplaces.push({ name: 'Amazon', url: amazonUrl });
        }
        if (flipkartUrl) {
            marketplaces.push({ name: 'Flipkart', url: flipkartUrl });
        }
        // Fallback or default marketplace (optional, but good practice)
        if (marketplaces.length === 0) {
            marketplaces.push({ name: 'Vendor Store', url: '#'}); // Use a placeholder or error if required
        }
        // <<< END NEW LOGIC >>>

        // Prepare the JSON payload
        
        const data = {
    name: formData.get('name'),
    price: parseFloat(formData.get('price')),
    category: formData.get('category'),
    type: formData.get('type'),
    brand: formData.get('brand'),
    image: base64Image,
    quantity: parseFloat(formData.get('quantity')), // parse float because backend expects float
    unit: formData.get('unit'),
    marketplaces: marketplaces // <<< CRITICAL: Include the new array >>>
};


        const response = await fetch('/api/product/add', {  // singular "product"
    method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            formMessage.textContent = result.message;
            formMessage.style.color = 'green';
            form.reset();
            // Clear and hide preview
            document.getElementById('image-preview-container').style.display = 'none'; 
            document.getElementById('image-preview').src = '#'; 
            fetchProductsForManagement(); 
        } else {
            formMessage.textContent = `Error: ${result.message}`;
            formMessage.style.color = 'red';
        }
    } catch (error) {
        console.error('Error adding product:', error);
        formMessage.textContent = 'An unexpected error occurred during submission.';
        formMessage.style.color = 'red';
    }
}


    // --- Product Management/Delete Logic (UNCHANGED) ---

    async function fetchProductsForManagement() {
        const tableBody = document.getElementById('product-list-body');
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');

        tableBody.innerHTML = '';
        loadingState.style.display = 'block';
        emptyState.style.display = 'none';

        try {
            const response = await fetch('/api/products');
            const products = await response.json();

            loadingState.style.display = 'none';

            if (products.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

           products.forEach(product => {
    const row = document.createElement("div");
    row.className = "product-row";

    row.innerHTML = `
        <span class="pid">${product._id.substring(0,4)}...</span>
        <span class="pname">${product.name}</span>
        <span>${product.category || 'N/A'}</span>
        <span>${product.type || 'N/A'}</span>
        <span class="price">₹ ${product.price?.toFixed(2) || 'N/A'}</span>
        <span>
            <button class="delete-btn" onclick="deleteProduct('${product._id}')">
                <i class="fa-solid fa-trash"></i>
            </button>
        </span>
    `;

    tableBody.appendChild(row);
});


        } catch (error) {
            console.error('Error fetching products:', error);
            loadingState.innerHTML = '<span style="color:red;">Error loading products. Check Flask/MongoDB.</span>';
        }
    }

    async function deleteProduct(productId) {
    if (!confirm('Are you sure you want to delete this product?')) return;

    try {
        const response = await fetch(`/api/products/delete/${productId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (response.ok) {
            alert("Product deleted!");
            fetchProductsForManagement(); // Refresh the list
        } else {
            alert("Error: " + result.error);
        }
    } catch (error) {
        console.error("Delete request failed:", error);
        alert("Failed to connect to server.");
    }
}



// MASTER THEME CONTROLLER - Controls ALL 5 pages
const modeBtn = document.getElementById('modeToggleBtn');
if (modeBtn) {
  function syncTheme() {
    const isNight = localStorage.getItem('zentail-theme') === 'night-mode';
    document.body.classList.toggle('night-mode', isNight);
    
    // Update button
    modeBtn.innerHTML = isNight ? 
      '<i class="fa-solid fa-sun"></i> Light Mode' : 
      '<i class="fa-solid fa-moon"></i> Night Mode';
  }
  
  // Load saved theme
  syncTheme();
  
  // Toggle controls ALL pages
  modeBtn.addEventListener('click', () => {
    const isNight = !document.body.classList.contains('night-mode');
    localStorage.setItem('zentail-theme', isNight ? 'night-mode' : 'light');
    syncTheme();
  });
  
  // Listen for other tabs changes
  window.addEventListener('storage', (e) => {
    if (e.key === 'zentail-theme') syncTheme();
  });
}
  </script>

  <style>


body { background: var(--bg-light); color: var(--text-main); transition: all 0.3s ease; font-family: 'Inter', sans-serif; }
body.night-mode { background: var(--bg-dark); color: var(--text-dark); }

/* Headers */
.zentail-header, nav { background: var(--card-light); border-color: rgba(255,255,255,0.3); }
body.night-mode .zentail-header, body.night-mode nav { background: var(--card-dark); border-color: rgba(255,255,255,0.1); }

/* Master Toggle (admin.html only) */
.mode-toggle { 
  position: fixed; top: 20px; right: 20px; z-index: 1000;
  background: var(--primary); color: white; border: none; padding: 12px 20px;
  border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s;
}
.mode-toggle:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(99,102,241,0.4); }


/* Admin Container */
.admin-container { 
  background: var(--card-light); padding: 40px; border-radius: 24px; max-width: 1000px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.1);
}
body.night-mode .admin-container { 
  background: var(--card-dark); box-shadow: 0 20px 40px rgba(0,0,0,0.4);
}

/* Form Elements */
.admin-form input, .admin-form select, .admin-form textarea {
  background: rgba(255,255,255,0.9); border: 1px solid #e2e8f0; 
  border-radius: 12px; padding: 15px; font-size: 14px;
}
body.night-mode .admin-form input, body.night-mode .admin-form select,
body.night-mode .admin-form textarea {
  background: rgba(255,255,255,0.15); border-color: #475569; color: var(--text-dark);
}

/* Product Table */
.product-row { 
  background: rgba(255,255,255,0.8); border-radius: 12px; padding: 20px; 
  border: 1px solid rgba(255,255,255,0.2); margin-bottom: 15px;
}
body.night-mode .product-row { 
  background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.08);
}

.product-list-header { 
  background: linear-gradient(90deg, var(--primary), var(--accent)); 
  color: white; padding: 15px; border-radius: 12px; font-weight: 700;
}



    /*  ADD PRODUCT PAGE - 06 */
/* --- ADMIN PAGE STYLES (for add_product.html) --- */

.admin-main {
    max-width: 600px;
    margin: 40px auto;
    padding: 20px;
}

.add-product-container {
    background: var(--light-card-bg, #fff);
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border: 1px solid #eee;
}

body.night-mode .add-product-container {
    background: var(--baddie-card);
    border-color: #333;
}

.add-product-container h1 {
    font-size: 2em;
    color: var(--light-hero-h1, #af6d7e);
    margin-bottom: 10px;
}

.add-product-container p {
    color: var(--light-text, #666);
    margin-bottom: 25px;
    font-size: 0.9em;
}

.product-form .form-group {
    margin-bottom: 18px;
}

.product-form label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--light-text, #333);
}

.product-form input[type="text"],
.product-form input[type="number"],
.product-form select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box; /* Includes padding in the element's total width and height */
    font-size: 1em;
    transition: border-color 0.2s;
    background: var(--light-bg, #f9f9f9);
    color: var(--light-text, #333);
}

.product-form input:focus,
.product-form select:focus {
    border-color: #bb6a7f;
    outline: none;
    box-shadow: 0 0 0 2px rgba(187, 106, 127, 0.2);
}

.submit-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 4px;
    background: linear-gradient(90deg, #ff9900, #ffda84);
    color: white;
    font-weight: 700;
    font-size: 1.1em;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    margin-top: 10px;
}

.submit-btn:hover {
    background: linear-gradient(90deg, #e68a00, #ffcc77);
    transform: translateY(-1px);
}

.submit-btn .fa-plus {
    margin-right: 8px;
}
/* ========================================= */
/* --- 6 - ADMIN MANAGEMENT STYLES --- */
/* ========================================= */

/* --- PRODUCT IMAGE FIX (For products.html) --- */
.product-image {
    position: relative;
    overflow: hidden;
    height: 250px; 
    border-bottom: 1px solid var(--card-border, #f0f0f0);
    display: flex; 
    align-items: center;
    justify-content: center;
}

.product-image img {
    width: 100%;
    height: 100%;
    /* FIX: 'contain' ensures the entire image fits within the bounds */
    object-fit: contain; 
    transition: transform 0.3s ease-in-out;
    padding: 10px; /* Adds space around the image */
}

/* ========================================= */
/* --- ADMIN PAGE STYLES (For add-product.html) --- */
/* ========================================= */

/* --- ADMIN SECTION STYLES --- */

.admin-container {
    max-width: 1000px;
    margin: 40px auto;
    padding: 30px;
    background: var(--light-card-bg);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

.admin-title {
    font-size: 2em;
    color: var(--light-hero-h1);
    border-bottom: 2px solid var(--card-border);
    padding-bottom: 15px;
    margin-bottom: 30px;
}

/* <<< NEW STYLE: For the 'External Purchase Links' heading >>> */
.admin-subtitle {
    font-size: 1.4em; /* Slightly larger for better visual separation */
    color: var(--light-hero-h1); 
    margin-top: 30px;
    margin-bottom: 15px;
    grid-column: 1 / -1; /* Ensures it spans the full form width */
    font-weight: 700;
}
/* ----------------------------------------------------------- */

/* Form Styles */
.admin-form {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Set form to two columns */
    gap: 15px 30px; /* CRITICAL: Allows items to flow naturally */
}

/* Keep the simple full-span rules for elements that should always take 100% width */
.admin-form input[type="text"]#name, /* Product Name input */
.admin-form input[type="number"]#price, /* Price input */
.admin-form input[type="text"]#brand, /* Brand input */
.admin-form input[type="file"]#image-file, /* File input */
.admin-form .form-group:has(input[type="text"]#name), /* Full Name group */
.admin-form .form-group:has(input[type="number"]#price), /* Full Price group */
.admin-form .form-group:has(input[type="text"]#brand), /* Full Brand group */
.admin-form .form-group:has(input[type="file"]#image-file), /* Full Image group */
.admin-form .admin-subtitle,
.admin-form .submit-btn,
.admin-form .form-message,
.admin-form .image-preview-container {
    grid-column: 1 / -1; 

}
.form-group-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--light-text);
}

.admin-form input,
.admin-form select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--card-border);
    border-radius: 6px;
    background: var(--light-bg);
    color: var(--light-text);
}

.submit-btn {
    grid-column: 1 / -1; /* Span across both columns */
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    transition: background 0.2s;
    margin-top: 15px;
}

.submit-btn:hover {
    background: linear-gradient(45deg, #0056b3, #004499);
}

.form-message {
    grid-column: 1 / -1;
    text-align: center;
    font-weight: 600;
}

/* =====================
   THEME VARIABLES
   ===================== */

:root {
    --bg: #f4f6fb;
    --card: #ffffff;
    --text: #0f172a;
    --muted: #64748b;
    --border: #e5e7eb;
    --primary: #2563eb;
    --danger: #dc2626;
}

body.night-mode {
    --bg: #020617;
    --card: #020617;
    --text: #e5e7eb;
    --muted: #94a3b8;
    --border: #1e293b;
    --primary: #3b82f6;
    --danger: #f87171;
}

/* =====================
   BASE
   ===================== */

body {
    background: var(--bg);
    color: var(--text);
    font-family: Inter, system-ui, sans-serif;
}

/* =====================
   TOGGLE BUTTON
   =====================

.theme-toggle {
    position: fixed;
    top: 16px;
    right: 16px;
    background: var(--card);
    border: 1px solid var(--border);
    padding: 8px 10px;
    border-radius: 6px;
    cursor: pointer;
    z-index: 1000;
}

/* =====================
   CONTAINER
   ===================== */

.admin-container {
    max-width: 1550px;
    margin: 40px auto;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 30px;
}

/* =====================
   TITLES
   ===================== */

.admin-title {
    font-size: 1.6rem;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
    margin-bottom: 25px;
}

/* =====================
   FORM
   ===================== */

.admin-form {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 18px 30px;
}

.admin-form .submit-btn,
.admin-form .form-message,
.admin-form .admin-subtitle,
.admin-form .form-group:has(#name),
.admin-form .form-group:has(#price),
.admin-form .form-group:has(#image-file) {
    grid-column: 1 / -1;
}

.form-group label {
    font-size: 13px;
    font-weight: 600;
    color: var(--muted);
}

.admin-form input,
.admin-form select {
    width: 100%;
    padding: 10px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text);
}

/* =====================
   SUBMIT
   ===================== */

.submit-btn {
    background: var(--primary);
    color: #fff;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-weight: 700;
    cursor: pointer;
}

/* =====================
   PRODUCT LIST HEADER
   ===================== */

.product-list-header {
    display: grid;
    grid-template-columns: 90px 1.5fr 1fr 1fr 1fr 80px;
    gap: 10px;
    padding: 10px 12px;
    margin-top: 1px;
    background: var(--primary);
    color: #fff;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    border-radius: 6px;
    
}

/* =====================
   PRODUCT LIST
   ===================== */

.product-list {
    display: flex;
    flex-direction: column;
}

.product-row {
    display: grid;
    grid-template-columns: 90px 1.5fr 1fr 1fr 1fr 80px;
    gap: 10px;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    align-items: center;
    font-size: 13px;
}

.product-row:hover {
    background: rgba(0,0,0,0.04);
}

body.night-mode .product-row:hover {
    background: rgba(255,255,255,0.04);
}

/* =====================
   COLUMN STYLES
   ===================== */

.pid {
    font-family: monospace;
    color: var(--muted);
}

.price {
    font-weight: 600;
    color: #16a34a;
}

/* =====================
   DELETE BUTTON
   ===================== */

.delete-btn {
    border: 1px solid var(--danger);
    background: transparent;
    color: var(--danger);
    padding: 4px 6px;
    font-size: 12px;
    border-radius: 4px;
    cursor: pointer;
}

.delete-btn:hover {
    background: var(--danger);
    color: #fff;
}

/* =====================
   EMPTY STATE
   ===================== */

.empty-state {
    margin-top: 15px;
    text-align: center;
    font-size: 13px;
    color: var(--muted);
}
/* Back button pill */
.back-btn {

  gap: 8px;
justify-content: flex-end;
position: relative;
  padding: 14px;
  border-radius: 9px;
  border: 1px solid rgba(0, 0, 0, 0.06);
  background: #ffffff;
  color: #333;
top: 25px;
  font-family: 'Inter', sans-serif;
  font-size: 0.9rem;
  font-weight: 500;

  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
  transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.15s ease;
}

.back-icon {
  font-size: 1rem;
  line-height: 1;
}

.back-btn:hover {
  background: #f7f7f7;
  box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
  transform: translateY(-1px);
}

.back-btn:active {
  transform: translateY(0);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
}
/* Blinking Emergency Indicator */
.blink-emergency {
    color: #ff4d4f;
    font-weight: 800;
    font-size: 2rem;
    animation: blinker 1s linear infinite;
}
@keyframes blinker { 50% { opacity: 0; } }

.stat-card {
    transition: transform 0.3s ease;
}
.stat-card:hover { transform: translateY(-5px); }


/* Booking Dark Mode */
body.night-mode {
  background: var(--baddie-bg);
}

body.night-mode .appointment-panel {
  background: rgba(40,40,60,0.7);
  color: var(--baddie-text);
  border-color: rgba(255,255,255,0.1);
}

body.night-mode .reason-box {
  background: rgba(255,255,255,0.08);
  color: var(--baddie-text);
}

body.night-mode .btn {
  background: rgba(255,255,255,0.1);
  color: var(--baddie-text);
}

body.night-mode .section-title {
  color: var(--baddie-accent);
}

  </style>
<script>
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("night-mode");
  }
</script>

</body>
</html>